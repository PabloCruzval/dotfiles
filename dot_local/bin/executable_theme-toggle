#!/bin/bash

THEME_DIR="$HOME/.config/themes"
CACHE_DIR="$HOME/.cache/theme"
THEME_NAME=${1:-"default"}
THEME_FILE="$THEME_DIR/${THEME_NAME}.json"

mkdir -p "$CACHE_DIR"

if [ ! -f "$THEME_FILE" ]; then
    echo "Error: The theme '$THEME_NAME' does not exist in $THEME_DIR"
    echo "Usage: theme-toggle [theme-name]"
    exit 1
fi

echo "Applying theme: $THEME_NAME..."

cp "$THEME_FILE" "$CACHE_DIR/current.json"
quickshell ipc call theme applyColors "$(cat "$CACHE_DIR/current.json")"

ACTIVE_HEX=$(jq -r '.colors.active_border' "$THEME_FILE" | tr -d '#')
INACTIVE_HEX=$(jq -r '.colors.inactive_border' "$THEME_FILE" | tr -d '#')
SHADOW_HEX=$(jq -r '.colors.shadow' "$THEME_FILE" | tr -d '#')
cat <<EOF > "$CACHE_DIR/hyprland_colors.conf"
\$active_border = rgba(${ACTIVE_HEX}ff)
\$inactive_border = rgba(${INACTIVE_HEX}ff)
\$shadow_color = rgba(${SHADOW_HEX}ee)
EOF
hyprctl reload > /dev/null

THEME_TYPE=$(jq -r '.type' "$THEME_FILE")
if [ "$THEME_TYPE" = "dark" ]; then
    gsettings set org.gnome.desktop.interface color-scheme "prefer-dark"
    gsettings set org.gnome.desktop.interface gtk-theme "Adwaita-dark"
    ICON="weather-clear-night"
else
    gsettings set org.gnome.desktop.interface color-scheme "prefer-light"
    gsettings set org.gnome.desktop.interface gtk-theme "Adwaita"
    ICON="weather-clear"
fi

notify-send "Theme Manager" "Theme '$THEME_NAME' applied successfully" -i "$ICON"
